enable_language(CUDA)

set(ELECTRODECHARGE_CUDA_LIBRARY_NAME ElectrodeChargePluginCUDA)
set(SHARED_TARGET ${ELECTRODECHARGE_CUDA_LIBRARY_NAME})

set(API_INCLUDE_DIRS "${CMAKE_CURRENT_SOURCE_DIR}/include")
set(API_INCLUDE_FILES)
foreach(dir ${API_INCLUDE_DIRS})
    file(GLOB fullpaths ${dir}/*.h)
    set(API_INCLUDE_FILES ${API_INCLUDE_FILES} ${fullpaths})
    include_directories(BEFORE ${dir})
endforeach()

file(GLOB SOURCE_CPP ${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp)
file(GLOB SOURCE_CU ${CMAKE_CURRENT_SOURCE_DIR}/src/*.cu)
set(SOURCE_FILES ${SOURCE_CPP} ${SOURCE_CU})
include_directories(BEFORE ${CMAKE_SOURCE_DIR}/openmmapi/include)
include_directories(BEFORE ${CMAKE_SOURCE_DIR}/openmmapi/include/internal)

add_library(${SHARED_TARGET} SHARED ${SOURCE_FILES} ${API_INCLUDE_FILES})

set_target_properties(${SHARED_TARGET} PROPERTIES
    CUDA_SEPARABLE_COMPILATION ON
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED YES
    CUDA_STANDARD 17
    CUDA_STANDARD_REQUIRED YES
    COMPILE_FLAGS "-DOPENMM_BUILDING_SHARED_LIBRARY ${EXTRA_COMPILE_FLAGS}"
    LINK_FLAGS "${EXTRA_COMPILE_FLAGS}")

target_link_libraries(${SHARED_TARGET} OpenMM OpenMMCUDA ${CUDA_LIBRARIES} ${SHARED_PLUGIN_TARGET})

install(TARGETS ${SHARED_TARGET} DESTINATION ${CMAKE_INSTALL_PREFIX}/lib/plugins)
